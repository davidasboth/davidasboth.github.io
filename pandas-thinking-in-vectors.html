<!DOCTYPE html>
<html lang="en">

<head>
	<!-- Required meta tags always come first -->
	<meta charset="utf-8">

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-68436188-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-68436188-1');
	</script>


	<!-- Start cookieyes banner -->
    <script id="cookieyes" type="text/javascript" src="https://cdn-cookieyes.com/client_data/2808e7a66d4c9b126f5d2ac9/script.js"></script>
    <!-- End cookieyes banner --> 

	<!-- Favicon stuff -->
	<link rel="apple-touch-icon" sizes="180x180" href="/theme/images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/theme/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/theme/images/favicon-16x16.png">
	<link rel="manifest" href="/theme/images/site.webmanifest">

	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>David Asboth - Data Solutions &amp; Consultancy - Pandas: Thinking in Vectors</title>

	<link rel="canonical" href="/pandas-thinking-in-vectors.html">
	
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"> 
	
	<link rel="stylesheet" href="/theme/css/style.css">

  



    <meta name="tags" content="pandas" />
    <meta name="tags" content="python" />

</head>

<body>
	<header id="stickyHeader">
		<div class="container">
			<a href="/"><img src="/theme/images/da-logo.svg" alt="David Asboth logo" id="header-logo"/></a>
			<nav>
				<ul>
					<li>
						<a href="/#solutions">Solutions</a>
					</li>
					<li>
							<a href="/#about">About</a>
					</li>
					<!--
					<li>
							<a href="/articles">Articles</a>
					</li>
					-->
					<li>
					  <a href="#contact" class="button button-filled">Contact</a>
					</li>
				</ul>
			</nav>
		</div>
	</header>

<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/pandas-thinking-in-vectors.html" rel="bookmark"
         title="Permalink to Pandas: Thinking in Vectors">Pandas: Thinking in Vectors</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2016-11-04T20:35:00+00:00">
      Fri 04 November 2016
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="/author/david.html">david</a>
    </address>
    <div class="category">
        Category: <a href="/category/data-science.html">data science</a>
    </div>
    <div class="tags">
        Tags:
            <a href="/tag/pandas.html">pandas</a>
            <a href="/tag/python.html">python</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>The more you use pandas to wrangle your data the more likely you'll come
across something complicated that you won't be sure how to do. I found
this quite quickly when trying to calculate metrics with time series
data for example.</p>
<p>In these cases quite often the first solution that pops into my head
will be the naive, brute force one. Something like "well we can loop
through all the rows and perform a computation on each row one by one".</p>
<p>That is almost never the right approach, because it will be <em>slow</em>.</p>
<p>The better solution is almost always to make use of vectorisation.</p>
<p>Pandas is built on top of numpy, which is built with vectors in mind -
that is, manipulating entire arrays at once rather than the individual
elements.</p>
<p>That way of thinking can be a hard to adjust to when the temptation is
to use loops.</p>
<p>Sometimes it's not a bad idea to start with the brute force approach to
be confident of the answer, and then move to a vectorised solution. For
large datasets though, this move can easily be the difference between
the script taking seconds or hours to run.</p>
<h1>Examples</h1>
<h2>Date Methods</h2>
<p>Applying methods to a column of date values is a common data
manipulation task, for example when extracting the day as a new feature.
There are (at least) two functionally identical ways of doing this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Method 1 - row by row</span>
<span class="n">days</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">my_dataframe</span><span class="p">[</span><span class="s2">&quot;my_date_column&quot;</span><span class="p">]:</span>
    <span class="n">days</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
<span class="n">my_dataframe</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">days</span>

<span class="c1"># Method 2 - using the inbuilt and vectorised date functionality</span>
<span class="n">my_dataframe</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_dataframe</span><span class="p">[</span><span class="s2">&quot;my_date_column&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
</code></pre></div>

<p>They'll do exactly the same thing, but the second will be orders of
magnitude faster.</p>
<h2>Subtracting Consecutive Values</h2>
<p>This is one of those problems where, if you don't know the pandas way to
do it, it's easy to start thinking row by row.</p>
<p>Again, here are two functionally identical ways of doing it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Method 1 - a function to loop through the elements one by one</span>
<span class="k">def</span> <span class="nf">naive_diff</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="n">diff_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)):</span>
        <span class="c1"># first value needs to be NaN</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">diff_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">series</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">diff_values</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">naive_diff</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">])</span>

<span class="c1"># Method 2 - using the pandas shift() function</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;diff_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
</code></pre></div>

<p>As well as being shorter, the second method is again much faster.</p>
<h1>Conclusion</h1>
<p>This was just a <em>very</em> brief introduction into thinking in vectors when
using pandas.</p>
<p>The code is available <a href="https://github.com/davidasboth/blog-notebooks/blob/master/pandas-thinking-in-vectors/pandas-vector-examples.ipynb">as a Jupyter notebook</a>.</p>
<p>The take away message is that whenever you need to do something to each
row, it's worth spending time doing some research to look for an
appropriate, in built function, and thinking a bit harder about how to
solve it in a vectorised way.</p>
<h2>Footnote: Apply and Itertuples</h2>
<p>If you absolutely must loop through the dataframe row by row, you should
consider using apply and itertuples. They are two pandas functions that
let you perform elementwise computation, but are faster than manually
looping through the row indices.</p>
<p>There are further good tips <a href="http://stackoverflow.com/questions/7837722/what-is-the-most-efficient-way-to-loop-through-dataframes-with-pandas">under this StackOverflow question</a>.</p>
<h2>Further Reading</h2>
<p>When doing some research for this post I came across <a href="https://www.datascience.com/blog/straightening-loops-how-to-vectorize-data-aggregation-with-pandas-and-numpy/">this blog post</a>,
which is worth a read on the subject.</p><script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div><!-- /.entry-content -->
</section>

	<footer>
		<div class="container flex-container">
			<p>© 2022 David Asboth. Site designed with love by <a href="http://design.barbasboth.com/">Barbara Asboth</a>. All Rights Reserved.</p>
			<p>hello@davidasboth.com</p>
		</div>
	</footer>
	<script>
	// Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
		
	var header = document.getElementById("stickyHeader");

	// Get the offset position of the navbar
	var sticky = header.offsetTop + '180';
	function toggleStickyHeader() {
	  if (window.pageYOffset > sticky) {
		header.classList.add("sticky");
	  } else {
		header.classList.remove("sticky");
	  }
	}
	window.onscroll = function() {toggleStickyHeader()};
	</script>
</body>

</html>